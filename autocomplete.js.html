<script>
// Autocomplete functionality
let autocompleteTimeout;
let pendingJobData = null; // L∆∞u t·∫°m data job khi ƒëang th√™m customer/partner
let lastSelectedCustomerName = '';
let lastSelectedPartnerName = '';

// L∆∞u tr·ªØ k·∫øt qu·∫£ search ƒë·ªÉ d√πng khi select
let cachedCustomers = [];
let cachedPartners = [];
let cachedLocations = [];

// Preload data khi m·ªü form
let preloadedCustomers = [];
let preloadedPartners = [];

// Preload customers v√† partners khi app load
function preloadAutocompleteData() {
  if (!spreadsheetId) return;
  
  // Load customers
  google.script.run
    .withSuccessHandler(function(customers) {
      preloadedCustomers = customers || [];
      cachedCustomers = preloadedCustomers;
    })
    .withFailureHandler(function(error) {
      console.error('Preload customers error:', error);
    })
    .getAllCustomers(spreadsheetId);
  
  // Load partners
  google.script.run
    .withSuccessHandler(function(partners) {
      preloadedPartners = partners || [];
      cachedPartners = preloadedPartners;
    })
    .withFailureHandler(function(error) {
      console.error('Preload partners error:', error);
    })
    .getAllPartners(spreadsheetId);
}

// Customer Autocomplete
function handleCustomerInput(inputElement) {
  const query = inputElement.value;
  const customerIdInput = document.getElementById('customerId');
  
  // N·∫øu user ƒëang g√µ kh√°c v·ªõi t√™n ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥, clear ID
  if (customerIdInput && customerIdInput.value && query !== lastSelectedCustomerName) {
    customerIdInput.value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
  }
  
  searchCustomerAutocomplete(query);
}

function searchCustomerAutocomplete(query) {
  clearTimeout(autocompleteTimeout);
  const resultsDiv = document.getElementById('customerAutocomplete');
  
  if (!resultsDiv) return;
  
  // N·∫øu kh√¥ng c√≥ query, hi·ªÉn th·ªã danh s√°ch preloaded
  if (!query || query.length < 1) {
    if (preloadedCustomers.length > 0) {
      cachedCustomers = preloadedCustomers.slice(0, 10);
      renderCustomerAutocomplete(cachedCustomers, '');
    } else {
      resultsDiv.classList.remove('active');
    }
    return;
  }
  
  // T√¨m trong cache tr∆∞·ªõc (instant)
  const lowerQuery = query.toLowerCase();
  const filtered = preloadedCustomers.filter(c => 
    c.name.toLowerCase().includes(lowerQuery) ||
    c.phone.includes(query) ||
    c.email.toLowerCase().includes(lowerQuery)
  ).slice(0, 10);
  
  cachedCustomers = filtered;
  renderCustomerAutocomplete(filtered, query);
}

function renderCustomerAutocomplete(customers, query) {
  const resultsDiv = document.getElementById('customerAutocomplete');
  if (!resultsDiv) return;
  
  let html = '';
  
  if (customers.length > 0) {
    customers.forEach((customer, index) => {
      html += `
        <div class="autocomplete-item" data-index="${index}" data-type="customer" onclick="selectCustomerByIndex(${index})">
          <div class="name">${highlightMatch(customer.name, query)}</div>
          <div class="info">${customer.phone || ''} ${customer.email ? '‚Ä¢ ' + customer.email : ''}</div>
        </div>
      `;
    });
  }
  
  html += `
    <div class="autocomplete-add" onclick="showNewCustomerForm('${escapeForAttr(query)}')">
      ‚ûï Th√™m kh√°ch h√†ng m·ªõi "${escapeHtml(query)}"
    </div>
  `;
  
  resultsDiv.innerHTML = html;
  resultsDiv.classList.add('active');
}

function selectCustomerByIndex(index) {
  const customer = cachedCustomers[index];
  if (!customer) return;
  
  try {
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerPhone').value = customer.phone || '';
    document.getElementById('customerEmail').value = customer.email || '';
    document.getElementById('customerAutocomplete').classList.remove('active');
    lastSelectedCustomerName = customer.name;
    
    // Visual feedback
    showToast('ƒê√£ ch·ªçn: ' + customer.name, 'success');
  } catch (e) {
    console.error('Error selecting customer:', e);
  }
}

// Gi·ªØ l·∫°i function c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch
function selectCustomer(id, name, phone, email) {
  try {
    document.getElementById('customerId').value = id;
    document.getElementById('customerName').value = name;
    document.getElementById('customerPhone').value = phone;
    document.getElementById('customerEmail').value = email;
    document.getElementById('customerAutocomplete').classList.remove('active');
    lastSelectedCustomerName = name;
  } catch (e) {
    console.error('Error selecting customer:', e);
  }
}

// Hi·ªÉn th·ªã form th√™m customer m·ªõi (thay v√¨ prompt)
function showNewCustomerForm(prefillName) {
  document.getElementById('customerAutocomplete').classList.remove('active');
  
  // L∆∞u t·∫°m data job hi·ªán t·∫°i
  saveCurrentJobFormData();
  
  const html = `
    <form id="newCustomerInJobForm" onsubmit="submitNewCustomerInJob(event)">
      <div class="form-group">
        <label>T√™n kh√°ch h√†ng *</label>
        <input type="text" id="newCustName" required value="${prefillName}" placeholder="Nguy·ªÖn VƒÉn A">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i *</label>
          <input type="tel" id="newCustPhone" required placeholder="0901234567">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newCustEmail" placeholder="email@example.com">
        </div>
      </div>
      
      <div class="form-group">
        <label>ƒê·ªãa ch·ªâ</label>
        <input type="text" id="newCustAddress" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n...">
      </div>
      
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <textarea id="newCustNotes" placeholder="Ghi ch√∫ v·ªÅ kh√°ch h√†ng..."></textarea>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="cancelNewCustomerInJob()">H·ªßy</button>
        <button type="submit" class="btn btn-primary">üíæ L∆∞u & Ch·ªçn</button>
      </div>
    </form>
  `;
  
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalTitle').textContent = '‚ûï Th√™m kh√°ch h√†ng m·ªõi';
  document.getElementById('newCustPhone').focus();
}

function submitNewCustomerInJob(e) {
  e.preventDefault();
  
  const customerData = {
    name: document.getElementById('newCustName').value.trim(),
    phone: document.getElementById('newCustPhone').value.trim(),
    email: document.getElementById('newCustEmail').value.trim(),
    address: document.getElementById('newCustAddress').value.trim(),
    notes: document.getElementById('newCustNotes').value.trim()
  };
  
  if (!customerData.name) {
    showToast('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!', 'error');
    return;
  }
  
  showLoading();
  
  try {
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result.success) {
          showToast('ƒê√£ th√™m kh√°ch h√†ng: ' + result.customer.name, 'success');
          invalidateCache('customers');
          
          // Restore job form v√† ƒëi·ªÅn customer info
          restoreJobFormWithCustomer(result);
        } else {
          showToast(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showToast('L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ th√™m kh√°ch h√†ng'), 'error');
        console.error('Add customer error:', error);
      })
      .addCustomer(customerData, spreadsheetId);
  } catch (e) {
    hideLoading();
    showToast('L·ªói h·ªá th·ªëng: ' + e.message, 'error');
    console.error('Exception in submitNewCustomerInJob:', e);
  }
}

function cancelNewCustomerInJob() {
  // Restore job form v·ªõi data ƒë√£ l∆∞u
  restoreJobForm();
}

// L∆∞u data job form hi·ªán t·∫°i
function saveCurrentJobFormData() {
  try {
    pendingJobData = {
      jobId: document.getElementById('jobId')?.value || '',
      customerId: document.getElementById('customerId')?.value || '',
      customerName: document.getElementById('customerName')?.value || '',
      customerPhone: document.getElementById('customerPhone')?.value || '',
      customerEmail: document.getElementById('customerEmail')?.value || '',
      shootDate: document.getElementById('shootDate')?.value || '',
      location: document.getElementById('location')?.value || '',
      jobType: document.getElementById('jobType')?.value || '',
      totalAmount: parseFormattedNumber(document.getElementById('totalAmount')?.value),
      paidAmount: parseFormattedNumber(document.getElementById('paidAmount')?.value),
      jobStatus: document.getElementById('jobStatus')?.value || 'Ch·ªù ch·ª•p',
      driveLink: document.getElementById('driveLink')?.value || '',
      partnerId: document.getElementById('partnerId')?.value || '',
      partnerName: document.getElementById('partnerName')?.value || '',
      partnerFee: parseFormattedNumber(document.getElementById('partnerFee')?.value),
      notes: document.getElementById('notes')?.value || ''
    };
  } catch (e) {
    console.error('Error saving job form data:', e);
    pendingJobData = null;
  }
}

// Restore job form v√† ƒëi·ªÅn customer m·ªõi
function restoreJobFormWithCustomer(customerResult) {
  if (pendingJobData) {
    pendingJobData.customerId = customerResult.customerId;
    pendingJobData.customerName = customerResult.customer.name;
    pendingJobData.customerPhone = customerResult.customer.phone || '';
    pendingJobData.customerEmail = customerResult.customer.email || '';
  }
  restoreJobForm();
}

// Restore job form v√† ƒëi·ªÅn partner m·ªõi
function restoreJobFormWithPartner(partnerResult) {
  if (pendingJobData) {
    pendingJobData.partnerId = partnerResult.partnerId;
    pendingJobData.partnerName = partnerResult.partner.name;
  }
  restoreJobForm();
}

// Restore job form
function restoreJobForm() {
  showJobForm(pendingJobData);
  pendingJobData = null;
}

// Partner Autocomplete
function handlePartnerInput(inputElement) {
  const query = inputElement.value;
  const partnerIdInput = document.getElementById('partnerId');
  
  // N·∫øu user ƒëang g√µ kh√°c v·ªõi t√™n ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥, clear ID
  if (partnerIdInput && partnerIdInput.value && query !== lastSelectedPartnerName) {
    partnerIdInput.value = '';
    if (document.getElementById('partnerEmail')) {
      document.getElementById('partnerEmail').value = '';
    }
  }
  
  searchPartnerAutocomplete(query);
}

function searchPartnerAutocomplete(query) {
  clearTimeout(autocompleteTimeout);
  const resultsDiv = document.getElementById('partnerAutocomplete');
  
  if (!resultsDiv) return;
  
  // N·∫øu kh√¥ng c√≥ query, hi·ªÉn th·ªã danh s√°ch preloaded
  if (!query || query.length < 1) {
    if (preloadedPartners.length > 0) {
      cachedPartners = preloadedPartners.slice(0, 10);
      renderPartnerAutocomplete(cachedPartners, '');
    } else {
      resultsDiv.classList.remove('active');
    }
    return;
  }
  
  // T√¨m trong cache tr∆∞·ªõc (instant)
  const lowerQuery = query.toLowerCase();
  const filtered = preloadedPartners.filter(p => 
    p.name.toLowerCase().includes(lowerQuery) ||
    p.phone.includes(query) ||
    p.specialty.toLowerCase().includes(lowerQuery)
  ).slice(0, 10);
  
  cachedPartners = filtered;
  renderPartnerAutocomplete(filtered, query);
}

function renderPartnerAutocomplete(partners, query) {
  const resultsDiv = document.getElementById('partnerAutocomplete');
  if (!resultsDiv) return;
  
  let html = '';
  
  if (partners.length > 0) {
    partners.forEach((partner, index) => {
      html += `
        <div class="autocomplete-item" data-index="${index}" data-type="partner" onclick="selectPartnerByIndex(${index})">
          <div class="name">${highlightMatch(partner.name, query)}</div>
          <div class="info">${partner.specialty || ''} ${partner.phone ? '‚Ä¢ ' + partner.phone : ''}</div>
        </div>
      `;
    });
  }
  
  html += `
    <div class="autocomplete-add" onclick="showNewPartnerForm('${escapeForAttr(query)}')">
      ‚ûï Th√™m partner m·ªõi "${escapeHtml(query)}"
    </div>
  `;
  
  resultsDiv.innerHTML = html;
  resultsDiv.classList.add('active');
}

function selectPartnerByIndex(index) {
  const partner = cachedPartners[index];
  if (!partner) return;
  
  try {
    document.getElementById('partnerId').value = partner.id;
    document.getElementById('partnerName').value = partner.name;
    if (document.getElementById('partnerEmail')) {
      document.getElementById('partnerEmail').value = partner.email || '';
    }
    document.getElementById('partnerAutocomplete').classList.remove('active');
    lastSelectedPartnerName = partner.name;
    
    // Visual feedback
    showToast('ƒê√£ ch·ªçn: ' + partner.name, 'success');
  } catch (e) {
    console.error('Error selecting partner:', e);
  }
}

function selectPartner(id, name, email) {
  try {
    document.getElementById('partnerId').value = id;
    document.getElementById('partnerName').value = name;
    if (document.getElementById('partnerEmail')) {
      document.getElementById('partnerEmail').value = email;
    }
    document.getElementById('partnerAutocomplete').classList.remove('active');
    lastSelectedPartnerName = name; // L∆∞u t√™n ƒë√£ ch·ªçn
  } catch (e) {
    console.error('Error selecting partner:', e);
  }
}

// Hi·ªÉn th·ªã form th√™m partner m·ªõi (thay v√¨ prompt)
function showNewPartnerForm(prefillName) {
  document.getElementById('partnerAutocomplete').classList.remove('active');
  
  // L∆∞u t·∫°m data job hi·ªán t·∫°i
  saveCurrentJobFormData();
  
  const html = `
    <form id="newPartnerInJobForm" onsubmit="submitNewPartnerInJob(event)">
      <div class="form-group">
        <label>T√™n Partner *</label>
        <input type="text" id="newPartName" required value="${prefillName}" placeholder="T√™n partner">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i *</label>
          <input type="tel" id="newPartPhone" required placeholder="0901234567">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newPartEmail" placeholder="email@example.com">
        </div>
      </div>
      
      <div class="form-group">
        <label>Chuy√™n m√¥n</label>
        <select id="newPartSpecialty">
          <option value="">-- Ch·ªçn --</option>
          <option value="Photographer">üì∏ Photographer</option>
          <option value="Editor">üñ•Ô∏è Editor</option>
          <option value="Assistant">üôã Assistant</option>
          <option value="Makeup">üíÑ Makeup</option>
          <option value="Kh√°c">üìå Kh√°c</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <textarea id="newPartNotes" placeholder="Ghi ch√∫ v·ªÅ partner..."></textarea>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="cancelNewPartnerInJob()">H·ªßy</button>
        <button type="submit" class="btn btn-primary">üíæ L∆∞u & Ch·ªçn</button>
      </div>
    </form>
  `;
  
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalTitle').textContent = '‚ûï Th√™m partner m·ªõi';
  document.getElementById('newPartPhone').focus();
}

function submitNewPartnerInJob(e) {
  e.preventDefault();
  
  const partnerData = {
    name: document.getElementById('newPartName').value.trim(),
    phone: document.getElementById('newPartPhone').value.trim(),
    email: document.getElementById('newPartEmail').value.trim(),
    specialty: document.getElementById('newPartSpecialty').value,
    notes: document.getElementById('newPartNotes').value.trim()
  };
  
  if (!partnerData.name) {
    showToast('Vui l√≤ng nh·∫≠p t√™n partner!', 'error');
    return;
  }
  
  showLoading();
  
  try {
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        if (result.success) {
          showToast('ƒê√£ th√™m partner: ' + result.partner.name, 'success');
          invalidateCache('partners');
          
          // Restore job form v√† ƒëi·ªÅn partner info
          restoreJobFormWithPartner(result);
        } else {
          showToast(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showToast('L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ th√™m partner'), 'error');
        console.error('Add partner error:', error);
      })
      .addPartner(partnerData, spreadsheetId);
  } catch (e) {
    hideLoading();
    showToast('L·ªói h·ªá th·ªëng: ' + e.message, 'error');
    console.error('Exception in submitNewPartnerInJob:', e);
  }
}

function cancelNewPartnerInJob() {
  // Restore job form v·ªõi data ƒë√£ l∆∞u
  restoreJobForm();
}

// Location Autocomplete
function searchLocationAutocomplete(query) {
  clearTimeout(autocompleteTimeout);
  const resultsDiv = document.getElementById('locationAutocomplete');
  
  if (!query || query.length < 2 || !spreadsheetId) {
    resultsDiv.classList.remove('active');
    return;
  }
  
  autocompleteTimeout = setTimeout(() => {
    google.script.run
      .withSuccessHandler(function(locations) {
        renderLocationAutocomplete(locations, query);
      })
      .getLocationSuggestions(query, spreadsheetId);
  }, 300);
}

function renderLocationAutocomplete(locations, query) {
  const resultsDiv = document.getElementById('locationAutocomplete');
  
  if (locations.length === 0) {
    resultsDiv.classList.remove('active');
    return;
  }
  
  let html = '';
  locations.forEach((location, index) => {
    html += `
      <div class="autocomplete-item" data-index="${index}" onclick="selectLocationByIndex(${index})">
        <div class="name">üìç ${highlightMatch(location, query)}</div>
      </div>
    `;
  });
  
  cachedLocations = locations; // Cache k·∫øt qu·∫£
  resultsDiv.innerHTML = html;
  resultsDiv.classList.add('active');
}

function selectLocationByIndex(index) {
  const location = cachedLocations[index];
  if (!location) return;
  
  document.getElementById('location').value = location;
  document.getElementById('locationAutocomplete').classList.remove('active');
}

function selectLocation(location) {
  document.getElementById('location').value = location;
  document.getElementById('locationAutocomplete').classList.remove('active');
}

// Utility functions
function highlightMatch(text, query) {
  if (!query) return text;
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<strong>$1</strong>');
}

function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// Escape cho HTML attribute (d√πng trong onclick)
function escapeForAttr(text) {
  if (!text) return '';
  return text
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/"/g, '\\"');
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Close autocomplete when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.autocomplete-wrapper')) {
    document.querySelectorAll('.autocomplete-results').forEach(div => {
      div.classList.remove('active');
    });
  }
});

// Handle keyboard navigation for autocomplete
document.addEventListener('keydown', function(e) {
  const activeAutocomplete = document.querySelector('.autocomplete-results.active');
  if (!activeAutocomplete) return;
  
  const items = activeAutocomplete.querySelectorAll('.autocomplete-item, .autocomplete-add');
  const currentIndex = Array.from(items).findIndex(item => item.classList.contains('focused'));
  
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
    items.forEach(item => item.classList.remove('focused'));
    items[nextIndex].classList.add('focused');
    items[nextIndex].scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
    items.forEach(item => item.classList.remove('focused'));
    items[prevIndex].classList.add('focused');
    items[prevIndex].scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'Enter' && currentIndex >= 0) {
    e.preventDefault();
    items[currentIndex].click();
  } else if (e.key === 'Escape') {
    activeAutocomplete.classList.remove('active');
  }
});
</script>

<style>
.autocomplete-item.focused,
.autocomplete-add.focused {
  background: var(--bg-secondary);
}

.autocomplete-loading {
  padding: 16px;
  text-align: center;
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.autocomplete-results {
  z-index: 1000;
}
</style>
